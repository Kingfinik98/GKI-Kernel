name: BUILD2 GKI KERNELSUNEXT

on:
  workflow_dispatch:

env:
  KERNEL_SOURCE_DIR: kernel_source
  PATCH_DIR: ${{ github.workspace }}/kernel_source/SukiSU_patch
  COMMON_DIR: ${{ github.workspace }}/kernel_source/common
  DEFCONFIG: arch/arm64/configs/gki_defconfig
  BRAND: "-SirkelGila"

jobs:
  BUILD_GKI_KERNELSUNEXT:
    runs-on: ubuntu-latest

    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 5120
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      - name: Setup Workspace
        run: |
          echo "[1/14] Creating Workspace"
          mkdir -p $KERNEL_SOURCE_DIR
          echo "[‚úì] Workspace $KERNEL_SOURCE_DIR created"

      - name: Install Dependencies
        run: |
          echo "[2/14] Installing Dependencies"
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y git curl repo build-essential bc bison flex libssl-dev \
            libelf-dev python3 python3-pip unzip zip rsync libncurses-dev lld ccache
          echo "[‚úì] Dependencies  Installed"

      - name: Setup Git Identity
        run: |
          echo "[3/14] Setup git identity"
          git config --global user.email "kingfinix98@gmail.com"
          git config --global user.name "titit"
          echo "[‚úì] Setup completed"

      - name: Init Kernel Source
        run: |
          cd $KERNEL_SOURCE_DIR
          echo "[4/14] Init kernel source"
          repo init --depth=1 -u https://android.googlesource.com/kernel/manifest -b common-android12-5.10
          echo "[‚úì] Repo init success"

      - name: Sync Kernel Source
        run: |
          cd $KERNEL_SOURCE_DIR
          echo "[5/14] Sync kernel source"
          repo --trace sync -c -j$(nproc --all) --no-tags --fail-fast
          echo "[‚úì] Sync completed"

      - name: Cherry-pick Upstream Rama
        run: |
          cd $COMMON_DIR
          echo "[6/14] Upstream linux from Rama"
          git remote add rama https://github.com/ramabondanp/android_kernel_common-5.10.git
          git fetch -j12 rama
          git cherry-pick 2afc3cd 8f27b49 || echo "[!] Some commits may not apply cleanly"
          echo "[‚úì] Upstream completed"

      - name: Add KernelSU-Next
        run: |
          cd $COMMON_DIR
          echo "üß© Menambahkan KernelSU-Next"
          echo "‚û°Ô∏è Menjalankan skrip setup.sh untuk KernelSU-Next"
          curl -LSs "https://raw.githubusercontent.com/Kingfinik98/KernelSU-Next/refs/heads/legacy/kernel/setup.sh" | bash -
          echo "‚úÖ KernelSU-Next berhasil ditambahkan"

          git clone https://gitlab.com/simonpunk/susfs4ksu/ -b gki-android12-5.10 $KERNEL_SOURCE_DIR/sus
          cp -r $KERNEL_SOURCE_DIR/sus/kernel_patches/fs .
          cp -r $KERNEL_SOURCE_DIR/sus/kernel_patches/include .
          cp $KERNEL_SOURCE_DIR/sus/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch .
          patch -p1 < 50_add_susfs_in_gki-android12-5.10.patch
          echo "[‚úì] SUSFS patched"

      # --- Langkah yang diganti ---
      - name: Apply scope_min_manual_hooks_v1.6.patch
        working-directory: ${{ env.KERNEL_SOURCE_DIR }}
        run: |
          echo "[8/14] Apply scope_min_manual_hooks_v1.6.patch"
          echo "ü©π Menerapkan scope_min_manual_hooks_v1.6.patch..."
          cd common
          curl -o scope_min_manual_hooks_v1.6.patch https://raw.githubusercontent.com/WildKernels/kernel_patches/refs/heads/main/next/scope_min_manual_hooks_v1.6.patch
          
          echo "Menerapkan patch dengan patch --fuzz=3..."
          patch -p1 --fuzz=3 < scope_min_manual_hooks_v1.6.patch
          
          echo "‚úÖ Patch scope_min_manual_hooks_v1.6.patch berhasil diterapkan."
          rm -f scope_min_manual_hooks_v1.6.patch

      - name: Inline Patch module.c dan drm
        run: |
          echo "[9/14] Disable warn and check valid clones"
          sed -i '/pr_warn.*disagrees about version of symbol.*/,+1 s/.*/return 1;/' $COMMON_DIR/kernel/module.c
          sed -i '/^static int drm_atomic_check_valid_clones/,/^}/d' $COMMON_DIR/drivers/gpu/drm/drm_atomic_helper.c
          sed -i '/ret = drm_atomic_check_valid_clones/,/return ret;/d' $COMMON_DIR/drivers/gpu/drm/drm_atomic_helper.c
          echo "[‚úì] Disabled"

      - name: Modified gki_defconfig
        run: |
          echo "[10/14] Enable KSU SUSFS ETC Config"
          DEFCONFIG_FILE="$COMMON_DIR/${DEFCONFIG}"
          {
            echo "CONFIG_KSU=y"
            echo "CONFIG_KPM=n"
            echo "CONFIG_KSU_SUSFS_SUS_SU=n"
            echo "CONFIG_KSU_MANUAL_HOOK=y"
            echo "CONFIG_KSU_KPROBES_HOOK=n"
            echo "CONFIG_KSU_SUSFS=y"
            echo "CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
            echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y"
            echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n"
            echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y"
            echo "CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y"
            echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y"
            echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y"
            echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
            echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y"
            echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y"
            echo "CONFIG_TMPFS_XATTR=y"
            echo "CONFIG_TMPFS_POSIX_ACL=y"
            echo "CONFIG_IP_NF_TARGET_TTL=y"
            echo "CONFIG_IP6_NF_TARGET_HL=y"
            echo "CONFIG_IP6_NF_MATCH_HL=y"
            echo "CONFIG_TCP_CONG_ADVANCED=y"
            echo "CONFIG_TCP_CONG_BBR=y"
            echo "CONFIG_NET_SCH_FQ=y"
            echo "CONFIG_TCP_CONG_BIC=n"
            echo "CONFIG_TCP_CONG_WESTWOOD=n"
            echo "CONFIG_TCP_CONG_HTCP=n"
            echo "CONFIG_DEFAULT_BBR=y"
          } >> "$DEFCONFIG_FILE"
          echo "[‚úì] Config Configured"

      - name: Disable check_defconfig
        run: |
          echo "[11/14] Disable Check Defconfig"
          sed -i 's/check_defconfig//' $COMMON_DIR/build.config.gki
          echo "[‚úì] Disabled"

      - name: Set Kernel Name and Branding
        run: |
          cd $KERNEL_SOURCE_DIR
          echo "[12/14] Set Kernel Brand"
          echo "echo \"$BRAND\"" > ./common/scripts/setlocalversion
          chmod +x ./common/scripts/setlocalversion

          DEFCONFIG2="./common/arch/arm64/configs/gki_defconfig"
          sed -i '/^CONFIG_LOCALVERSION=/d' "$DEFCONFIG2"
          echo "CONFIG_LOCALVERSION=\"$BRAND\"" >> "$DEFCONFIG2"
          echo "CONFIG_LOCALVERSION_AUTO=n" >> "$DEFCONFIG2"
          echo "[‚úì] Completed"

      - name: Install ccache
        run: |
          echo "[13/14] Installing ccache"
          sudo apt update && sudo apt upgrade -y && sudo apt install -y ccache python3 git curl
          echo "[‚úì] Cacched installed"

      - name: Build Kernel
        run: |
          echo "[14/14] Building kernel with ccache"
          sed -i 's/BUILD_SYSTEM_DLKM=1/BUILD_SYSTEM_DLKM=0/' $COMMON_DIR/build.config.gki.aarch64
          sed -i '/MODULES_ORDER=android\/gki_aarch64_modules/d' $COMMON_DIR/build.config.gki.aarch64
          sed -i '/KMI_SYMBOL_LIST_STRICT_MODE/d' $COMMON_DIR/build.config.gki.aarch64

          export CC="ccache clang"
          export USE_CCACHE=1
          ccache -M 5G

          cd $KERNEL_SOURCE_DIR
          KBUILD_BUILD_USER=goten KBUILD_BUILD_HOST=aetherium LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh -j$(nproc)
          echo "[‚úì] Kernel build with status Success"

      - name: Upload Image to Pixeldrain
        id: upload
        run: |
          IMAGE_PATH=$(find $KERNEL_SOURCE_DIR/out -type f -name Image | head -n 1)
          if [ -z "$IMAGE_PATH" ]; then
            echo "‚ùå Image not found"
            exit 1
          fi
          RESPONSE=$(curl -s -u :53bc8bf8-584d-444e-97e3-715a1b3526bf -F file=@"$IMAGE_PATH" https://pixeldrain.com/api/file)
          FILE_ID=$(echo "$RESPONSE" | grep -oP '"id":"\K[^"]+')
          echo "link=https://pixeldrain.com/u/$FILE_ID" >> $GITHUB_OUTPUT

      - name: Show link download
        run: |
          echo "üéâ Build Finished!"
          echo "üîó Link Image: ${{ steps.upload.outputs.link }}"