name: LEGACY1 KSUN

on:
  workflow_dispatch:
    inputs:
      kernel_name:
        description: 'Custom Kernel Name (Leave empty for default)'
        required: false
        default: ''
        type: string
      clang_version:
        description: 'Select Clang Version'
        required: true
        type: choice
        options:
          - 'r536225 (Clang 19)'
          - 'r547379 (Clang 20)'

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-22.04

    steps:
      - name: Free disk space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          swap-size-mb: 10240
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.name "Boltx"
          git config --global user.email "Kingfinik98@gmail.com"

      - name: Install build tools
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y git curl repo build-essential bc bison flex libssl-dev \
            libelf-dev python3 python3-pip unzip zip rsync libncurses-dev lld

      - name: Init & Sync GKI
        run: |
          mkdir gki && cd gki
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android12-5.10 --depth=1
          repo sync -c --no-tags --no-clone-bundle --optimized-fetch -j$(nproc --all)

      - name: Apply Rama patch
        run: |
          cd gki/common
          echo "Downloading commit 881fa16..."
          curl -L "https://github.com/ramabondanp/android_kernel_common-5.10/commit/881fa16.patch" -o rama.patch
          
          echo "Applying patch..."
          if git am -3 < rama.patch; then
            echo "Done."
          else
            echo "git am failed, trying patch -p1..."
            git am --abort
            patch -p1 --fuzz=3 < rama.patch || true
          fi
          rm rama.patch

      - name: Tweak build config
        run: |
          sed -i '2d' gki/common/build.config.gki

      - name: Setup KSUNEX LEGACY
        run: |
          cd gki/common 
          echo "ðŸ§© Merge dan tambahkan KernelSU-Next dan SUSFS"
          echo "âž¡ï¸ Menambahkan KernelSU-Next"
          curl -LSs "https://raw.githubusercontent.com/Kingfinik98/KernelSU-Next/refs/heads/legacy/kernel/setup.sh" | bash -
          echo "âœ… KernelSU-Next added"

      - name: Apply common fixes
        working-directory: gki/common
        run: |
          echo "Applying manual cherry-picks..."
          PATCH_URL="https://github.com/ramabondanp/android_kernel_common-5.10/commit/4fe04b60009e.patch"
          PATCH_FILE="common_fix.patch"

          # DL patch
          curl -L "${PATCH_URL}" -o "${PATCH_FILE}"

          # Verify
          if [ ! -s "${PATCH_FILE}" ]; then
            echo "Patch download failed!"
            exit 1
          fi

          # Apply
          if git am -3 < "${PATCH_FILE}"; then
            echo "Applied successfully."
          else
            echo "git am failed, forcing patch..."
            git am --abort
            patch -p1 --fuzz=3 < "${PATCH_FILE}" || true
          fi
          rm "${PATCH_FILE}"

      - name: Fix Stack Protector
        working-directory: gki/common
        run: |
          echo "Fixing Stack Protector config..."
          sed -i '/config STACKPROTECTOR_PER_TASK/{n;s/def_bool y/bool "Stack Protector per task"\n\tdefault y/;}' arch/arm64/Kconfig
          echo "# CONFIG_STACKPROTECTOR_PER_TASK is not set" >> arch/arm64/configs/gki_defconfig

      - name: Patch module & DRM
        run: |
          cd gki
          echo "Fixing module.c & DRM..."
          sed -i '/pr_warn.*disagrees about version of symbol.*/,+1 s/.*/return 1;/' common/kernel/module.c
          sed -i '/^static int drm_atomic_check_valid_clones/,/^}/d' common/drivers/gpu/drm/drm_atomic_helper.c
          sed -i '/ret = drm_atomic_check_valid_clones/,/return ret;/d' common/drivers/gpu/drm/drm_atomic_helper.c

      - name: Remove check_defconfig
        run: |
          cd gki
          sed -i 's/check_defconfig//' ./common/build.config.gki

      - name: Inject KSU & Network configs
        run: |
          DEFCONFIG="gki/common/arch/arm64/configs/gki_defconfig"
          echo "Injecting configs..."
          
            # --- KSU & KPM Configs ---
          echo "CONFIG_KSU=y" >> $DEFCONFIG
          echo "CONFIG_KPM=n" >> $DEFCONFIG
          echo "CONFIG_KSU_KPROBES=n" >> $DEFCONFIG
          echo "CONFIG_KPROBES=n" >> $DEFCONFIG
          echo "CONFIG_HAVE_KPROBES=n" >> $DEFCONFIG
          echo "CONFIG_KPROBE_EVENTS=n" >> $DEFCONFIG
          # AKTIFKAN MANUAL SYSCALL HOOK
          echo "CONFIG_KSU_MANUAL_HOOK=y" >> $DEFCONFIG
          echo "CONFIG_KSU_SYSCALL_HOOK=y" >> $DEFCONFIG
          
          # Net/FS Tweaks
          echo "CONFIG_TMPFS_XATTR=y" >> $DEFCONFIG
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> $DEFCONFIG
          echo "CONFIG_IP_NF_TARGET_TTL=y" >> $DEFCONFIG
          echo "CONFIG_IP6_NF_TARGET_HL=y" >> $DEFCONFIG
          echo "CONFIG_IP6_NF_MATCH_HL=y" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_ADVANCED=y" >> $DEFCONFIG 
          echo "CONFIG_TCP_CONG_BBR=y" >> $DEFCONFIG
          echo "CONFIG_NET_SCH_FQ=y" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_BIC=n" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_WESTWOOD=n" >> $DEFCONFIG
          echo "CONFIG_TCP_CONG_HTCP=n" >> $DEFCONFIG 
          echo "CONFIG_DEFAULT_BBR=y" >> $DEFCONFIG

      - name: Set version
        run: |
          cd gki/common
          echo "" > scripts/setlocalversion
          chmod +x scripts/setlocalversion
          
          KERNEL_NAME="${{ github.event.inputs.kernel_name }}"

          if [ -n "$KERNEL_NAME" ]; then
             echo "Using custom name: $KERNEL_NAME"
             if grep -q '^EXTRAVERSION *=' Makefile; then
               sed -i "s/^EXTRAVERSION *=.*/EXTRAVERSION = -$KERNEL_NAME/" Makefile
             else
               echo "EXTRAVERSION = -$KERNEL_NAME" >> Makefile
             fi
          else
             echo "Using default kernel name"
          fi

      - name: Set HZ=300
        run: |
          echo -e '\nCONFIG_HZ_300=y\nCONFIG_HZ=300' >> gki/common/arch/arm64/configs/gki_defconfig
      
      - name: Apply JackA1ltman Syscall Hook Script
        working-directory: gki
        run: |
          echo "ðŸ©¹ Menerapkan patch hook syscall dari JackA1ltman..."
          cd common
          curl -o syscall_hook_patches.sh https://raw.githubusercontent.com/JackA1ltman/NonGKI_Kernel_Build_2nd/refs/heads/mainline/Patches/syscall_hook_patches.sh
          chmod +x syscall_hook_patches.sh
          ./syscall_hook_patches.sh
          echo "âœ… Syscall hook script dari JackA1ltman berhasil dijalankan."
          rm -f syscall_hook_patches.sh

      - name: Setup Clang
        working-directory: gki
        run: |
          mkdir -p prebuilts-master/clang/host/linux-x86
          
          if [ "${{ github.event.inputs.clang_version }}" == "r536225 (Clang 19)" ]; then
            CLANG_VER="clang-r536225"
            CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main-kernel-2025/clang-r536225.tar.gz"
          else
            CLANG_VER="clang-r547379"
            CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/62cdcefa89e31af2d72c366e8b5ef8db84caea62/clang-r547379.tar.gz"
          fi
          
          echo "CLANG_VER=$CLANG_VER" >> $GITHUB_ENV

          mkdir -p prebuilts-master/clang/host/linux-x86/$CLANG_VER
          cd prebuilts-master/clang/host/linux-x86
          curl -L "${CLANG_URL}" | tar -xz -C $CLANG_VER
          
          # Symlink to default expected clang version
          rm -rf clang-r416183b
          ln -sf $CLANG_VER clang-r416183b

      - name: Commit changes
        run: |
          cd gki/common
          git add .
          git commit -m "Final tree" || true

      - name: Compile
        run: |
          cd gki
          LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Aetherium-Kernel-Image
          path: gki/out/android12-5.10/common/arch/arm64/boot/Image
          if-no-files-found: warn

      - name: Push to PixelDrain
        if: always() 
        run: |
          if [ -f gki/out/android12-5.10/common/arch/arm64/boot/Image ]; then
            curl -u :23c84c82-ce06-4e35-bc1f-69eaa13b9958 \
              -F file=@gki/out/android12-5.10/common/arch/arm64/boot/Image \
              https://pixeldrain.com/api/file
          else
            echo "Image not found."
          fi